{"version":3,"sources":["../src/heatmap.js"],"names":[],"mappings":";;;;;;;AAAO;;AACA;;AACA;;AACA;;AACA;;;;AAIP,cAAQ,MAAR,CAAe,oBAAf,EAAqC,SAArC,CAA+C,qBAA/C,EAAsE,UAAS,UAAT,EAAqB,OAArB,EAA8B;AAClG,eAAO;AACL,oBAAU,GAAV;AACA,oBAAU,cAAV;AACA,gBAAM,cAAS,KAAT,EAAgB,IAAhB,EAAsB;AAC1B,gBAAI,OAAO,MAAM,IAAN,CADe;AAE1B,gBAAI,YAAY,KAAK,SAAL,CAFU;AAG1B,gBAAI,QAAQ,KAAK,KAAL,CAHc;AAI1B,gBAAI,IAAJ,CAJ0B;AAK1B,gBAAI,YAAJ,CAL0B;AAM1B,gBAAI,sBAAsB,IAAtB,CANsB;AAO1B,gBAAI,YAAY,MAAM,KAAN;;;AAPU,gBAU1B,CAAK,MAAL,CAAY,EAAZ,CAAe,QAAf,EAAyB,UAAS,UAAT,EAAqB;AAC5C,qBAAO,cAAc,IAAd,CADqC;AAE5C,kBAAI,CAAC,IAAD,EAAO;AACT,qBAAK,OAAL,GADS;AAET,uBAFS;eAAX;AAIA,6BAN4C;aAArB,CAAzB,CAV0B;;AAmB1B,qBAAS,eAAT,CAAyB,WAAzB,EAAsC;AACpC,kBAAI,CAAC,MAAM,MAAN,CAAa,IAAb,IAAqB,MAAM,MAAN,CAAa,SAAb,EAAwB;AAChD,uBAAO,CAAP,CADgD;eAAlD;;AAIA,kBAAI,MAAM,MAAN,CAAa,YAAb,EAA2B;AAC7B,oBAAI,eAAe,EAAE,MAAF,CAAS,IAAT,EAAe,UAAS,MAAT,EAAiB;AACjD,yBAAO,OAAO,cAAP,CAAsB,MAAM,MAAN,CAAtB,KAAwC,KAAxC,CAD0C;iBAAjB,CAA9B,CADyB;AAI7B,oBAAI,QAAQ,KAAM,KAAK,aAAa,MAAb,CAJM;AAK7B,uBAAO,KAAK,GAAL,CAAS,KAAT,EAAgB,KAAK,KAAL,CAAW,cAAY,CAAZ,CAA3B,CAAP,CAL6B;eAA/B,MAMO;AACL,uBAAO,EAAP,CADK;eANP;aALF;;AAgBA,qBAAS,gBAAT,GAA4B;AAC1B,kBAAI;AACF,oBAAI,SAAS,KAAK,MAAL,GAAc,gBAAgB,KAAK,MAAL,CAA9B,CADX;AAEF,qBAAK,GAAL,CAAS,QAAT,EAAmB,SAAS,IAAT,CAAnB,CAFE;;AAIF,uBAAO,IAAP,CAJE;eAAJ,CAKE,OAAM,CAAN,EAAS;;AACT,wBAAQ,GAAR,CAAY,CAAZ,EADS;AAET,uBAAO,KAAP,CAFS;eAAT;aANJ;;AAYA,qBAAS,iBAAT,GAA6B;AAC3B,kBAAI,CAAC,IAAD,EAAO;AACT,uBAAO,IAAP,CADS;eAAX;;AAIA,kBAAI,CAAC,kBAAD,EAAqB;AAAE,uBAAO,IAAP,CAAF;eAAzB;;AAEA,kBAAG,EAAE,QAAF,CAAW,IAAX,CAAH,EAAqB;AACnB,6CAA6B,IAA7B,EADmB;AAEnB,uBAAO,IAAP,CAFmB;eAArB;;AAKA,kBAAI,KAAK,KAAL,OAAiB,CAAjB,EAAoB;AACtB,uBAAO,IAAP,CADsB;eAAxB;aAZF;;AAiBA,qBAAS,QAAT,CAAkB,IAAlB,EAAwB;;AAEtB,kBAAI,QAAQ,KAAK,QAAL,EAAR,CAFkB;AAGtB,mBAAK,IAAI,IAAI,CAAJ,EAAO,IAAI,KAAK,MAAL,EAAa,GAAjC,EAAsC;AACpC,oBAAI,SAAS,KAAK,CAAL,CAAT,CADgC;AAEpC,oBAAI,OAAO,MAAM,OAAO,KAAP,GAAe,CAAf,CAAb,CAFgC;AAGpC,oBAAI,WAAW,IAAI,YAAJ,CAAiB,MAAM,KAAN,CAAY,OAAO,KAAP,GAAe,CAAf,CAAZ,CAA8B,MAA9B,CAA5B;;;AAHgC,oBAMhC,EAAE,QAAF,CAAW,MAAM,QAAN,CAAf,EAAgC;AAC9B,yBAAO,kBAAP,CAA0B,QAA1B,EAAoC,MAAM,QAAN,EAAgB,IAApD,EAD8B;iBAAhC,MAEO;;;;AAIL,sBAAI,eAAe,CAAC,KAAK,YAAL,IAAqB,CAAC,CAAD,CAAtB,GAA4B,CAA5B,CAJd;AAKL,yBAAO,kBAAP,CAA0B,QAA1B,EAAoC,YAApC,EAAkD,KAAK,cAAL,GAAsB,CAAtB,CAAlD,CALK;iBAFP;;AAUA,oBAAG,CAAC,UAAU,OAAV,EAAmB;AAAE,wBAAM,OAAN,GAAF;iBAAvB;eAhBF;;;AAHsB,kBAuBlB,MAAM,KAAN,CAAY,CAAZ,EAAe,KAAf,EAAsB;AACxB,oBAAI,aAAa,EAAE,gDAAF,EACd,IADc,CACT,MAAM,KAAN,CAAY,CAAZ,EAAe,KAAf,CADS,CAEd,QAFc,CAEL,IAFK,CAAb,CADoB;;AAKxB,2BAAW,GAAX,CAAe,YAAf,EAA6B,WAAW,KAAX,KAAqB,CAArB,CAA7B,CALwB;eAA1B;;;AAvBsB,kBAgClB,MAAM,KAAN,CAAY,CAAZ,EAAe,KAAf,EAAsB;AACxB,oBAAI,aAAa,EAAE,iDAAF,EACd,IADc,CACT,MAAM,KAAN,CAAY,CAAZ,EAAe,KAAf,CADS,CAEd,QAFc,CAEL,IAFK,CAAb,CADoB;;AAKxB,2BAAW,GAAX,CAAe,YAAf,EAA6B,WAAW,KAAX,KAAqB,CAArB,CAA7B,CALwB;eAA1B;aAhCF;;AAyCA,qBAAS,iBAAT,CAA2B,IAA3B,EAAiC,UAAjC,EAA6C;AAC3C,kBAAI,OAAO,MAAM,KAAN,CAAY,CAAZ,CAAP,CADuC;AAE3C,kBAAI,QAAQ,MAAM,KAAN,CAAY,CAAZ,CAAR,CAFuC;AAG3C,kBAAI,KAAK,IAAL,IAAa,KAAK,KAAL,EAAY;AAAE,2BAAW,IAAX,GAAkB,EAAlB,CAAF;eAA7B;AACA,kBAAI,MAAM,IAAN,IAAc,MAAM,KAAN,EAAa;AAAE,2BAAW,KAAX,GAAmB,EAAnB,CAAF;eAA/B;aAJF;;;AAzG0B,qBAiHjB,YAAT,GAAwB;AACtB,kBAAI,mBAAJ,EAAyB;AACvB,uBADuB;eAAzB;;AAIA,mBAAK,IAAI,IAAI,CAAJ,EAAO,IAAI,KAAK,MAAL,EAAa,GAAjC,EAAsC;AACpC,oBAAI,SAAS,KAAK,CAAL,CAAT,CADgC;;AAGpC,oBAAI,SAAS,EAAE,KAAF,CAAQ,OAAO,UAAP,CAAR,CACZ,MADY,CACL,UAAS,EAAT,EAAa;AACnB,yBAAO,GAAG,CAAH,MAAU,IAAV,CADY;iBAAb,CADK,CAIZ,MAJY,CAIL,UAAS,EAAT,EAAa;AACnB,yBAAO,GAAG,CAAH,CAAP,CADmB;iBAAb,CAJK,CAOZ,GAPY,CAOR,UAAS,EAAT,EAAa;AAChB,yBAAO;AACL,0BAAM,GAAG,CAAH,CAAN;AACA,2BAAO,GAAG,CAAH,CAAP;mBAFF,CADgB;iBAAb,CAPQ,CAaZ,OAbY,CAaJ,UAAS,EAAT,EAAa;AACpB,yBAAO,GAAG,IAAH,CADa;iBAAb,CAbI,CAgBZ,GAhBY,CAgBR,UAAS,MAAT,EAAiB,IAAjB,EAAuB;AAC1B,yBAAO;AACL,0BAAM,KAAK,KAAL,CAAW,OAAO,IAAP,CAAjB;AACA,+BAAW,EAAE,OAAF,CAAU,MAAV,EAAkB,UAAS,KAAT,EAAgB;AAC3C,6BAAO,MAAM,KAAN,CADoC;qBAAhB,CAA7B;mBAFF,CAD0B;iBAAvB,CAhBQ,CAuBV,KAvBU,EAAT,CAHgC;AA2BpC,uBAAO,IAAP,GAAc;AACZ,yBAAO,OAAO,KAAP;AACP,0BAAQ,MAAR;iBAFF;;;AA3BoC,oBAiChC,KAAK,YAAL,CAAkB,OAAO,KAAP,CAAtB,EAAqC;AACnC,yBAAO,IAAP,GAAc,EAAd,CADmC;iBAArC;eAjCF;;AAsCA,6BAAe,EAAE,KAAF,CAAQ,IAAR,EACd,GADc,CACV,UAAS,MAAT,EAAiB;AACpB,uBAAO,OAAO,IAAP,CADa;eAAjB,CADU,CAId,MAJc,CAIP,UAAS,MAAT,EAAiB;AACvB,uBAAO,OAAO,KAAP,CADgB;eAAjB,CAJO,CAOd,KAPc,EAAf,CA3CsB;;AAoDtB,uBAAS,QAAT,CAAkB,sBAAlB,EAA0C;AACxC,oBAAI;AACF,sBAAI,iBAAiB;AACnB,0BAAM,cAAN;AACA,0BAAM,YAAN;AACA,0BAAM,CAAC,MAAD,EAAS,QAAT,EAAmB,OAAnB,CAAN;AACA,6BAAS,iBAAS,KAAT,EAAgB,GAAhB,EAAqB;AAC5B,6BAAO,KAAK,GAAL,CAAU,QAAM,GAAN,EAAY,GAAtB,CAAP,CAD4B;qBAArB;mBAJP,CADF;AASF,sBAAI,MAAM,UAAN,EAAkB;AACpB,mCAAe,UAAf,GAA4B,MAAM,UAAN,CADR;mBAAtB;AAGA,sBAAI,MAAM,OAAN,EAAe;AACjB,mCAAe,OAAf,GAAyB,MAAM,OAAN,CADR;mBAAnB;AAGA,sBAAI,MAAM,gBAAN,IAA0B,MAAM,gBAAN,EAAwB;AACpD,mCAAe,WAAf,GAA6B,CAAC,MAAM,gBAAN,EAAwB,MAAM,gBAAN,CAAtD,CADoD;mBAAtD;AAGA,uBAAK,KAAL,CAAW,cAAX,EAlBE;iBAAJ,CAmBE,OAAO,CAAP,EAAU;AACV,0BAAQ,GAAR,CAAY,aAAZ,EAA2B,CAA3B,EADU;iBAAV;;AAIF,oBAAI,sBAAJ,EAA4B;AAC1B,uBAAK,kBAAL,GAD0B;iBAA5B;eAxBF;;AA6BA,kBAAI,gBAAgB,KAAhB,CAAJ,EAA4B;;AAE1B,yBAAS,KAAT,EAF0B;AAG1B,2BAAW,YAAW;AAAE,2BAAS,IAAT,EAAF;iBAAX,EAAgC,EAA3C,EAH0B;AAI1B,sCAAsB,MAAM,MAAN,CAAa,SAAb,CAJI;eAA5B,MAMK;AACH,yBAAS,IAAT,EADG;eANL;aAjFF;;AA4FA,qBAAS,eAAT,CAAyB,KAAzB,EAAgC;AAC9B,kBAAI,MAAM,MAAN,CAAa,SAAb,EAAwB;AAC1B,uBAAO,IAAP,CAD0B;eAA5B;AAGA,kBAAI,wBAAwB,IAAxB,IAAgC,MAAM,MAAN,CAAa,SAAb,KAA2B,mBAA3B,EAAgD;AAClF,uBAAO,IAAP,CADkF;eAApF;aAJF;;AASA,qBAAS,WAAT,CAAqB,KAArB,EAA4B,GAA5B,EAAiC,GAAjC,EAAsC;AACpC,kBAAI,OAAO,GAAP,IAAc,KAAd,EAAqB;AACvB,oBAAI,QAAQ,MAAM,GAAN,CADW;AAEvB,oBAAI,aAAa,KAAC,GAAM,KAAN,GAAe,IAAhB,CAFM;AAGvB,oBAAI,SAAS,QAAT,CAHmB;AAIvB,oBAAI,UAAU,WAAV,CAJmB;;AAMvB,oBAAI,cAAc,EAAd,EAAkB;AACpB,yBAAO,UAAP,CADoB;iBAAtB;AAGA,oBAAI,cAAc,IAAd,IAAsB,SAAS,MAAT,EAAiB;AACzC,yBAAO,OAAP,CADyC;iBAA3C;AAGA,oBAAI,cAAc,KAAd,EAAqB;AACvB,yBAAO,aAAP,CADuB;iBAAzB;AAGA,oBAAI,cAAc,OAAd,IAAyB,SAAS,OAAT,EAAkB;AAC7C,yBAAO,OAAP,CAD6C;iBAA/C;AAGA,uBAAO,OAAP,CAlBuB;eAAzB;;AAqBA,qBAAO,OAAP,CAtBoC;aAAtC;;AAyBA,iBAAK,IAAL,CAAU,cAAV,EAA0B,UAAU,KAAV,EAAiB,MAAjB,EAAyB;AACjD,oBAAM,MAAN,CAAa,YAAW;AACtB,wBAAQ,OAAR,CAAgB;AACd,wBAAQ,OAAO,GAAP,CAAW,OAAO,KAAP,CAAa,IAAb,CAAnB;AACA,sBAAQ,OAAO,GAAP,CAAW,OAAO,KAAP,CAAa,EAAb,CAAnB;iBAFF,EADsB;eAAX,CAAb,CADiD;aAAzB,CAA1B,CA/O0B;WAAtB;SAHR,CADkG;OAA9B,CAAtE","file":"heatmap.js","sourcesContent":["import angular from 'angular';\nimport $ from 'jquery';\nimport moment from 'moment';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport './bower_components/d3/d3.min.js';\nimport './bower_components/epoch/dist/js/epoch.min.js';\n\nangular.module('grafana.directives').directive('grafanaHeatmapEpoch', function($rootScope, timeSrv) {\n  return {\n    restrict: 'A',\n    template: '<div> </div>',\n    link: function(scope, elem) {\n      var ctrl = scope.ctrl;\n      var dashboard = ctrl.dashboard;\n      var panel = ctrl.panel;\n      var data;\n      var sortedSeries;\n      var legendSideLastValue = null;\n      var rootScope = scope.$root;\n\n      // Receive render events\n      ctrl.events.on('render', function(renderData) {\n        data = renderData || data;\n        if (!data) {\n          ctrl.refresh();\n          return;\n        }\n        render_panel();\n      });\n\n      function getLegendHeight(panelHeight) {\n        if (!panel.legend.show || panel.legend.rightSide) {\n          return 2;\n        }\n\n        if (panel.legend.alignAsTable) {\n          var legendSeries = _.filter(data, function(series) {\n            return series.hideFromLegend(panel.legend) === false;\n          });\n          var total = 23 + (22 * legendSeries.length);\n          return Math.min(total, Math.floor(panelHeight/2));\n        } else {\n          return 26;\n        }\n      }\n\n      function setElementHeight() {\n        try {\n          var height = ctrl.height - getLegendHeight(ctrl.height);\n          elem.css('height', height + 'px');\n\n          return true;\n        } catch(e) { // IE throws errors sometimes\n          console.log(e);\n          return false;\n        }\n      }\n\n      function shouldAbortRender() {\n        if (!data) {\n          return true;\n        }\n\n        if (!setElementHeight()) { return true; }\n\n        if(_.isString(data)) {\n          render_panel_as_graphite_png(data);\n          return true;\n        }\n\n        if (elem.width() === 0) {\n          return true;\n        }\n      }\n\n      function drawHook(plot) {\n        // Update legend values\n        var yaxis = plot.getYAxes();\n        for (var i = 0; i < data.length; i++) {\n          var series = data[i];\n          var axis = yaxis[series.yaxis - 1];\n          var formater = kbn.valueFormats[panel.yaxes[series.yaxis - 1].format];\n\n          // decimal override\n          if (_.isNumber(panel.decimals)) {\n            series.updateLegendValues(formater, panel.decimals, null);\n          } else {\n            // auto decimals\n            // legend and tooltip gets one more decimal precision\n            // than graph legend ticks\n            var tickDecimals = (axis.tickDecimals || -1) + 1;\n            series.updateLegendValues(formater, tickDecimals, axis.scaledDecimals + 2);\n          }\n\n          if(!rootScope.$$phase) { scope.$digest(); }\n        }\n\n        // add left axis labels\n        if (panel.yaxes[0].label) {\n          var yaxisLabel = $(\"<div class='axisLabel left-yaxis-label'></div>\")\n            .text(panel.yaxes[0].label)\n            .appendTo(elem);\n\n          yaxisLabel.css(\"margin-top\", yaxisLabel.width() / 2);\n        }\n\n        // add right axis labels\n        if (panel.yaxes[1].label) {\n          var rightLabel = $(\"<div class='axisLabel right-yaxis-label'></div>\")\n            .text(panel.yaxes[1].label)\n            .appendTo(elem);\n\n          rightLabel.css(\"margin-top\", rightLabel.width() / 2);\n        }\n      }\n\n      function processOffsetHook(plot, gridMargin) {\n        var left = panel.yaxes[0];\n        var right = panel.yaxes[1];\n        if (left.show && left.label) { gridMargin.left = 20; }\n        if (right.show && right.label) { gridMargin.right = 20; }\n      }\n\n      // Function for rendering panel\n      function render_panel() {\n        if (shouldAbortRender()) {\n          return;\n        }\n\n        for (var i = 0; i < data.length; i++) {\n          var series = data[i];\n\n          var values = _.chain(series.datapoints)\n          .reject(function(dp) {\n            return dp[0] === null;\n          })\n          .sortBy(function(dp) {\n            return dp[1];\n          })\n          .map(function(dp) {\n            return {\n              time: dp[1],\n              value: dp[0]\n            }\n          })\n          .groupBy(function(dp) {\n            return dp.time;\n          })\n          .map(function(values, time) {\n            return {\n              time: Math.floor(time / 1000),\n              histogram: _.countBy(values, function(value) {\n                return value.value;\n              })\n            };\n          }).value();\n          series.data = {\n            label: series.label,\n            values: values\n          }\n\n          // if hidden remove points\n          if (ctrl.hiddenSeries[series.alias]) {\n            series.data = [];\n          }\n        }\n\n        sortedSeries = _.chain(data)\n        .map(function(series) {\n          return series.data;\n        })\n        .sortBy(function(series) {\n          return series.label;\n        })\n        .value();\n\n        function callPlot(incrementRenderCounter) {\n          try {\n            var heatmapOptions = {\n              type: 'time.heatmap',\n              data: sortedSeries,\n              axes: ['left', 'bottom', 'right'],\n              opacity: function(value, max) {\n                return Math.pow((value/max), 0.7);\n              }\n            };\n            if (panel.windowSize) {\n              heatmapOptions.windowSize = panel.windowSize;\n            }\n            if (panel.buckets) {\n              heatmapOptions.buckets = panel.buckets;\n            }\n            if (panel.bucketRangeLower && panel.bucketRangeUpper) {\n              heatmapOptions.bucketRange = [panel.bucketRangeLower, panel.bucketRangeUpper];\n            }\n            elem.epoch(heatmapOptions);\n          } catch (e) {\n            console.log('epoch error', e);\n          }\n\n          if (incrementRenderCounter) {\n            ctrl.renderingCompleted();\n          }\n        }\n\n        if (shouldDelayDraw(panel)) {\n          // temp fix for legends on the side, need to render twice to get dimensions right\n          callPlot(false);\n          setTimeout(function() { callPlot(true); }, 50);\n          legendSideLastValue = panel.legend.rightSide;\n        }\n        else {\n          callPlot(true);\n        }\n      }\n\n      function shouldDelayDraw(panel) {\n        if (panel.legend.rightSide) {\n          return true;\n        }\n        if (legendSideLastValue !== null && panel.legend.rightSide !== legendSideLastValue) {\n          return true;\n        }\n      }\n\n      function time_format(ticks, min, max) {\n        if (min && max && ticks) {\n          var range = max - min;\n          var secPerTick = (range/ticks) / 1000;\n          var oneDay = 86400000;\n          var oneYear = 31536000000;\n\n          if (secPerTick <= 45) {\n            return \"%H:%M:%S\";\n          }\n          if (secPerTick <= 7200 || range <= oneDay) {\n            return \"%H:%M\";\n          }\n          if (secPerTick <= 80000) {\n            return \"%m/%d %H:%M\";\n          }\n          if (secPerTick <= 2419200 || range <= oneYear) {\n            return \"%m/%d\";\n          }\n          return \"%Y-%m\";\n        }\n\n        return \"%H:%M\";\n      }\n\n      elem.bind(\"plotselected\", function (event, ranges) {\n        scope.$apply(function() {\n          timeSrv.setTime({\n            from  : moment.utc(ranges.xaxis.from),\n            to    : moment.utc(ranges.xaxis.to),\n          });\n        });\n      });\n    }\n  };\n});\n"]}